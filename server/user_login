#!/bin/bash --login

export LESSSECURE=1

trap "" 20
trap intint INT
stty susp undef

# do nothing
function intint {
	:
}

EXPECTED_ARGS=0

if [ $# -ne $EXPECTED_ARGS ]; then
	exit
fi

. /var/lib/adom/etc/config

command=""
sage=$(cat ${HOME}/sage_status)
adom_ver=$(cat ${HOME}/adom_ver)
ttyq=$(cat ${HOME}/ttyrec_status)

if [ ! -e "${HOME}/.adom.data" ]; then
	ln -s ${HOME}/adom.data-$adom_ver ${HOME}/.adom.data
fi

until [ "$command" = "end" ]
do
	sage=$(cat ${HOME}/sage_status)
	adom_ver=$(cat ${HOME}/adom_ver)
	ttyq=$(cat ${HOME}/ttyrec_status)

	tput reset
	clear

	#Show server MOTD
        while read line; do echo -e $line; done < /var/lib/adom/etc/motd

	python /var/lib/adom/server/check_term.py
	res="$?"

	if [ "$res" == "1" ]; then
		echo ""
	fi

	quota -slq > /dev/null
        if [ $? == 1 ]; then
		echo -e " ** \e[1;31mWARNING: You are over your disk quota. Please type 'del'. \e[0m**"
        fi

	echo -ne "You're about to play \e[1mADoM\e[0m"
        case $adom_ver in
                "111")
                        echo -ne " version \e[4m1.1.1\e[0m, \e[4mnormal mode\e[0m"
                        ;;
                "100")
                        echo -ne " version \e[4m1.0.0\e[0m, \e[4mnormal mode\e[0m"
                        ;;
                "120p3")
                        echo -ne " version \e[4m1.2.0p3\e[0m, \e[4mnormal mode\e[0m"
                        ;;
                "120p4")
                        echo -ne " version \e[4m1.2.0p4\e[0m, \e[4mnormal mode\e[0m"
                        ;;
                "120p5")
                        echo -ne " version \e[4m1.2.0p5\e[0m, \e[4mnormal mode\e[0m"
                        ;;
                "120p6")
                        echo -ne " version \e[4m1.2.0p6\e[0m, \e[4mnormal mode\e[0m"
			;;
                "etr")
                        echo -ne " version \e[4m1.1.1\e[0m, \e[4meternium man challenge mode\e[0m"
                        ;;
                "swp")
                        echo -ne " version \e[4m1.1.1\e[0m, \e[4mswapgame mode\e[0m"
                        ;;
                *)
                        echo -ne " MISSING"
                        ;;
        esac
	if [ -e ${HOME}/silence ]; then
		printf ", \e[4mwithout\e[0m spectator messages, "
	else
		printf ", \e[4mwith\e[0m spectator messages, "
	fi

	echo -ne "with ADoM Sage \e[4m$sage\e[0m,"
        echo -e " and tty recordings \e[4m$ttyq\e[0m."

	if [[ $(date +%w) = 1 ]] ; then
                echo -e "     \e[4mNOTE\e[0m: It's Monday.";
	elif [[ $(date +%w-%d) = "5-13" ]]; then
                echo -e "     \e[4mNOTE\e[0m: It's Friday the 13th.";
        fi

	if [[ $(date +%m-%d) = "07-2" ]]; then
                echo -e "     \e[4mNOTE\e[0m: It's Creator's Day."
	elif [[ $(date +%m-%d) = "12-24" ]]; then
                echo -e "     \e[4mNOTE\e[0m: It's Christmas Eve."
	elif [[ $(date +%m-%d) = "12-31" ]]; then
                echo -e "     \e[4mNOTE\e[0m: It's New Year's Eve."
        fi

	echo ""
	 echo -ne "\e[1;33m[ a ]\e[0m launch ADoM (start or resume)	"
        echo -e "\e[1m[ h ]\e[0m view readme"
        echo -ne "\e[1m[ j ]\e[0m join this user's session (co-op)	"
        echo -e "\e[1m[ s ]\e[0m spectate other users' games"
        echo -e "\e[1;31m[ q ]\e[0m quit"
        echo ""
        echo -e "Select version:\n\e[1m[ mn ]\e[0m 1.1.1		\e[1m[ mp ]\e[0m 1.2.0pX		\e[1m[ ma ]\e[0m 1.0.0\n\e[1m[ me ]\e[0m Eternium Man				\e[1m[ ms ]\e[0m swapgame"
        echo ""
        echo -ne "\e[1m[ x ]\e[0m toggle ADoM Sage                  "
        echo -e "\e[1m[ r ]\e[0m toggle tty recording"
        echo -ne "\e[1m[ t ]\e[0m send message to another user      "

	if [ -e ${HOME}/silence ]; then
                echo -ne "\e[1m[ m ]\e[0m enable"
        else
                echo -ne "\e[1m[ m ]\e[0m disable"
        fi
        echo " receiving messages"

        echo ""
        if [ -e "/var/www/adom_users/${USER}" ]; then
                echo -ne "\e[1m[ d ]\e[0m disable"
        else
                echo -ne "\e[1m[ d ]\e[0m enable"
        fi
        echo " user dir access at http://ancardia.us.to/adom_users/${USER}"
        echo -e "\e[1m[ c ]\e[0m edit ADoM, ADoM Sage, and SSH key (RSA/DSA) configurations"
        echo ""
        echo -ne "\e[1m[ g ]\e[0m browse ADoM Guidebook (SPOILERS)  "
        echo -e "\e[1m[ kp ]\e[0m kill your processes (if stuck)"
        echo -e "\e[1m[ del ]\e[0m delete all your ttyrecs, slgs, vlgs, & sshs, (with confirmation)"
        echo -e "\e[1m[ pw ]\e[0m change your password"
        echo ""

	read -e -p "> " command
	case $command in
	[?h])
		echo ""
                echo "Press enter to view the readme.  PgUp/PgDn to move; up/down arrows to move"
                echo "between links, enter to follow a link (table of contents). "
                echo "External browsing is disabled. Press q to quit the readme."
                echo ""
                read
                TERM=screen elinks -localhost 1 /var/www/index.php
		continue
		;;

        'g')
                echo ""
                echo "Press enter to view the guidebook.  Keys:"
                echo ""
                echo "PgUp/PgDn to move"
                echo "Up/Down arrows to move between links"
                echo "Left/Right arrows to go back/forward"
                echo "Enter to follow a link"
                echo "/ to search"
                echo ""
                echo "External browsing is disabled. Press q to quit."
                read
                TERM=screen elinks -localhost 1 /var/www/guidebook/index.html
                continue
                ;;

	'a')
		clear

		python /var/lib/adom/server/check_term.py
		res="$?"

		if [ "$res" == "1" ]; then
			echo ""
			echo "Press enter to return to the main menu."
			read junk
			continue
		fi

		export sage
		export adom_ver
		export ttyq
		echo $adom_ver > /var/lib/adom/sockets/$USER

		if [ -e "${HOME}/.adom.data/.adom.cnt" ]; then
			/var/lib/adom/server/modify_cnt "${HOME}/.adom.data/.adom.cnt"
		fi

		screen -DR -c /var/lib/adom/server/user-screen -S adom -s \
		"/var/lib/adom/server/adom_wrapper"
		rm -f /var/lib/adom/sockets/$USER
		continue
		;;

	"mn")
		if [ -e "${HOME}/.adom.data/.adom.prc" ]; then
			echo "Cannot change version; ADoM is running!"
			sleep 2
			continue
		fi

		rm -f ${HOME}/.adom.data
		adom_ver="111"
		echo "$adom_ver" > ${HOME}/adom_ver
		ln -s ${HOME}/adom.data-$adom_ver ${HOME}/.adom.data
		continue
		;;

	"ma")
		if [ -e "${HOME}/.adom.data/.adom.prc" ]; then
			echo "Cannot change version; ADoM is running!"
			sleep 2
			continue
		fi

		rm -f ${HOME}/.adom.data
		adom_ver="100"
		echo "$adom_ver" > ${HOME}/adom_ver
			ln -s ${HOME}/adom.data-$adom_ver ${HOME}/.adom.data
		continue
		;;

        "mp")
                if [ -e "${HOME}/.adom.data/.adom.prc" ]; then
                        echo "Cannot change version; ADoM is running!"
                        sleep 2
                        continue
                fi

                DEF=${MAX_PRE}
                if [[ ! -f $HOME/donated ]]; then
                        DEF=3
                fi

                echo "Which prerelease (default: 1.2.0p${DEF})? "
                prompt=""
                for i in $(seq ${MIN_PRE} ${MAX_PRE}); do
                        prompt="${prompt}  (${i}) 1.2.0p${i}"
                done
                read -e -p "${prompt}: " pvers
                pvers="${pvers:-$DEF}"
                if [[ $pvers != *[[:digit:]]* ]] || [ $pvers -lt 3 ] || [ $pvers -gt $max_pre ]; then
                        echo "Invalid selection"
                        sleep 3
                        continue
                fi
                if [ $pvers -ge 4 ]; then
                        /var/lib/adom/server/donation_check.sh
                        if [ $? -ne 0 ]; then continue; fi
                fi

                rm -f ${HOME}/.adom.data
                adom_ver="120p${pvers}"
                echo "$adom_ver" > ${HOME}/adom_ver
                mkdir -p ${HOME}/adom.data-$adom_ver
                mkdir -p ${HOME}/backup-$adom_ver
                ln -s ${HOME}/adom.data-$adom_ver ${HOME}/.adom.data
                if [ "$sage" = "enabled" ]; then
                        echo "Sage with 1.2.0pX may not be stable! Use at own risk! (Press enter to continue)."
                        read
                fi
                continue
                ;;

	"me")
		if [ -e "${HOME}/.adom.data/.adom.prc" ]; then
			echo "Cannot change version; ADoM is running!"
			sleep 2
			continue
		fi

		rm -f ${HOME}/.adom.data
		adom_ver="etr"
		echo "$adom_ver" > ${HOME}/adom_ver
			ln -s ${HOME}/adom.data-$adom_ver ${HOME}/.adom.data
		continue
		;;

	"ms")
		if [ -e "${HOME}/.adom.data/.adom.prc" ]; then
			echo "Cannot change version; ADoM is running!"
			sleep 2
			continue
		fi

		rm -f ${HOME}/.adom.data
		adom_ver="swp"
		echo "$adom_ver" > ${HOME}/adom_ver
		ln -s ${HOME}/adom.data-$adom_ver ${HOME}/.adom.data
		continue
		;;

	'm')
		if [ -e ${HOME}/silence ]; then
			rm ${HOME}/silence
		else
			> ${HOME}/silence
		fi
		continue
		;;

	'x')
		if [ "$sage" = "disabled" ]; then
			echo "enabled" > ${HOME}/sage_status
		else
			echo "disabled" > ${HOME}/sage_status
		fi
		continue
		;;

        'r')
                if [ "$ttyq" = "disabled" ]; then
                        echo "enabled" > ${HOME}/ttyrec_status
                else
                        echo "disabled" > ${HOME}/ttyrec_status
                fi
                continue
                ;;

        'del')
                OLDSZ=$(du -shx $HOME | cut -f1)
                echo -e "Your homedir usage is $OLDSZ. Delete ALL your ttyrecs, vlgs, slgs, and .sshs?\n(y/N)?"
                read -e ANSWER
                if [[ $ANSWER = [yY]* ]]; then
                        find $HOME/ttyrecs -type f -delete -print
                        find $HOME -type f -name "*.ssh" -delete -print
                        find $HOME -type f -name "*.slg" -delete -print
                        find $HOME -type f -name "*.vlg" -delete -print
                        find $HOME -type f -name "core" -delete -print
                fi
                NEWSZ=$(du -shx $HOME | cut -f1)
                echo "Your new disk usage is $NEWSZ. (press enter)"
                read
                continue
                ;;

	'c')
		/var/lib/adom/server/conf_adom
		echo
		sleep 1
		continue
		;;

	'pw')
		passwd
		sleep 1
		continue
		;;

	'kp')
		clear
		rm -f /var/lib/adom/sockets/$USER
		python -u /var/lib/adom/server/irc_msg_kill.py
		continue
		;;

	'd')
		if [ -e "/var/lib/adom/public_html/adom_users/${USER}" ]; then
			rm "/var/lib/adom/public_html/adom_users/${USER}"
			echo "Directory link removed."
		else
			ln -s "${HOME}" "/var/lib/adom/public_html/adom_users/${USER}"
			echo "Directory link created."
		fi

		sleep 1
		continue
		;;

	'q')
		exit
		;;

	'e')
		exit
		;;

	'j')
		clear

		python /var/lib/adom/server/check_term.py
		res="$?"

		if [ "$res" == "1" ]; then
			echo ""
			echo "Press enter to return to the main menu."
			read junk
			continue
		fi

		screen -x -c /var/lib/adom/server/user-screen
		continue
		;;

	's')
		ssh -o "StrictHostKeyChecking no" -i /var/lib/adom/adomusers_id  spectator@localhost
		continue
		;;

	't')
		trap - INT
		/var/lib/adom/server/talk_at
		trap intint INT
		continue
		;;

	*)
		echo "Erroneous selection!"
		sleep 1
		continue
		;;
	esac
done
