Public ADOM Server install directions
See LICENSE for copyright and licensing details

Table of contents:
	I. Install and Configuration
		i. Install required tools
		ii. Local users
		iii. passwd.py
		iv. termrec
		v. sudo
		vi. quota
		vii. su to adomown
		viii. Check out code
		ix. Add other ADOM versions
		x. Patch and install ADOM versions
		xi. SSH key for spectating
		xii. crontab
	II. ADOM Sage
	
I. Install and Configuration
----------------------------

These instructions are written with a Debian or Ubuntu-based system in mind.
Any relatively modern Linux distribution will work, but Debian 6+ or Ubuntu
12.04+ are recommended.

i. Install required tools
=========================

The following software is required for all pieces to work:

* OpenSSH
* inotify
* quota support and quota tools
* sudo
* screen
* tmux 1.5+
* bsdiff & bspatch
* nano
* ELinks
* ttyrec
* termrec
* Python 2.6+
** IRCLib
** Pyinotify
** ConfigObj
** OAuth
** Tweepy
* Perl
** Bot::BasicBot
** Try::Tiny 
** String::Approx
** Sub::Exporter
** Term::ReadKey
** POE::Component::SSLify 
** Text::LevenshteinXS

On a Debian-bases system, the following command, run as root, should bring
in all you need:

apt-get install python-irclib elinks inotify-tools ttyrec quotatool quota\
 libbot-basicbot-perl libtry-tiny-perl libstring-approx-perl\
 libsub-exporter-perl sudo screen bsdiff nano hexcurse libterm-readkey-perl\
 wget python-pyinotify libpoe-component-sslify-perl python-configobj\
 python-oauth git openssh-server openssh-client\
 libtext-levenshteinxs-perl tmux python-tweepy

For compiling some binaries from source, or related tools, a compilers and
some development libraries are required:

apt-get install libncurses5-dev libbz2-dev zlib1g-dev gcc g++ make autoconf

Notes:
Debian Squeeze users will have to build libtext-levenshteinxs-perl tmux and
python-tweepy from source or another source (like Wheezy)

ii. Local Users
==============

The following users and group must be set up for full funcationality:

Group adomusers
Users adomown, adom, spectator, and ttyrecplay

Commands:
groupadd adomusers
useradd -d /var/lib/adom -c "ADOM owner" -s /bin/bash -g adomusers adomown
mkdir /var/lib/adom
chown adomown:adomusers /var/lib/adom
useradd -d /var/lib/adom -c "ADOM public login" -s\
 /var/lib/adom/server/public_login adom
useradd -d /var/lib/adom/server/spectator -c "ADOM spectator" -s\
 /var/lib/adom/server/spec_login spectator
useradd -d/var/lib/adom/server/ttyrecplay -c "ADOM TTY playback" -s\
 /var/lib/adom/server/ttyrecplay_login ttyrecplay

For adom, spectator, and ttyrecplay, set passwords the same as their username:
passwd adom
passwd spectator
passwd ttyrecplay

iii. passwd.py
==============

Install passwd.py (latest can be found at
http://newcenturycomputers.net/projects/passwd.html ):

Commands:
cd /tmp
wget http://newcenturycomputers.net/projects/download.cgi/passwd.py
python passwd.py install

iv. termrec 
============

Install termrec & termplay ( latest at http://angband.pl/termrec.html )

Commands:
cd /tmp
wget http://prdownloads.sourceforge.net/termrec/termrec-0.16.tar.gz
tar xzf termrec-0.16.tar.gz
cd termrec-0.16/
./configure && make && make install

v. sudo
=======

The adom user requires permission to add new users and set their quotas.

Add the following line to /etc/sudoers or /etc/sudoers.d/50-adom
(must be chmod 0440):

adomown    ALL = NOPASSWD: /usr/sbin/adduser, /usr/sbin/setquota

vi. quota
=========

Quota support should be added by editing /etc/fstab and adding the following 
to the filesystem options: 

relatime,errors=remount-ro,usrquota,usrjquota=aquota.user,jqfmt=vfsv0

Then run commands:

mount -o remount,usrquota /
quotacheck -avugm 
quotaon -a

vii. su to adomown
==================

The next steps should be done as the adomown user.  You'll be told when
it's time to return to root.

viii. Check out code
====================
Pick a directory (default: /var/lib/adom) and finally, check out the code:

git clone https://AlucardZero@bitbucket.org/AlucardZero/adom-server.git .

ix. Add other ADOM versions
===========================

Download any desired additional ADOM game versions.  Versions 1.0.0, 1.1.1, and
1.2.0p3 are included, in the same way as from ancardia.com (due to the license),
but 1.2.0 prereleases 4 to final cannot be distributed this way.  You must have
donated to the ADOM Resurrection IndieGoGo campaign to download and play them.
 
Where you have a choice, use the Debian 32-bit version.

x. Patch and install ADOM versions
==================================

1.0.0, 1.1.1, and 1.2.0p3 are provided.  Place other archives (32-bit Debian!)
in /var/lib/adom/software/ .

Binary changes are required to separate HISCORE files. To do yourself, edit the
adom binary in a hex editor (like hexcurse) and change both mentions of
adom_ds.cfg to something unique.

I have used:

1.0.0           adom_ds.100
1.1.1           adom_ds.111
Eternium Man:   adom_ds.etr
League:         adom_ds.lea
Swapgame:       adom_ds.swp
1.2.0p1-3:      adom_ds.12a
1.2.0p4-5:      adom_ds.12b
1.2.0p6-:       adom_ds.12c


Patch the binaries with the following commands:

mkdir /tmp/adom && cd $_

for i in 100 111; do
tar xzf /var/lib/adom/software/adom-$i-elf.tar.gz &&
bspatch adom/adom /var/lib/adom/bin/adom-$i-bin\
 /var/lib/adom/software/adom-$i-ds.binpatch
rm -rf ./adom
done

tar xzf /var/lib/adom/software/adom-111-elf.tar.gz
for i in lea etr swp; do
bspatch adom/adom /var/lib/adom/bin/adom-$i-bin\
 /var/lib/adom/software/adom-$i-ds.binpatch
done
rm -rf adom

for i in 3 4 5; do
tar xzf /var/lib/adom/software/adom_linux_debian_32_1.2.0_pre$i.tar.gz &&
bspatch adom/adom /var/lib/adom/bin/adom-120p$i-bin\
 /var/lib/adom/software/adom-120p$i-ds.binpatch
rm -rf ./adom
done

These are the md5sums of the resulting binaries:
2e870f9207c08e736d2e2a81ae1f7098  adom-100-bin
c7d6813e48cf19c163ac1a6eba8122ee  adom-111-bin
d95a75aa104dd306833ff3207ef022ed  adom-120p3-bin
43dd575a1196def002ee50d45cc4afa3  adom-120p4-bin
11d27e4466b94e1667916296178785d9  adom-120p5-bin
a2dc057b464a6ac6922772c705043346  adom-etr-bin
979e65fce3f6f67e093d9f95c4209720  adom-lea-bin
3128f86a6900e99e3ba0ec40b98e31d9  adom-swp-bin


(temp) link in /usr/games
for i in 100 111 120p3 120p4 120p5 120p6 lea etr swp; do
  ln -s /var/lib/adom/bin/adom-$i-bin /usr/games/adom-$i-bin
done
for i in 120p3 120p4 120p5 120p6; do
  ln -s /var/lib/adom/bin/adom-120pX /usr/games/adom-$i
done

xi. SSH key for spectating
==========================
Generate an ssh key for spectating from the user menu. Don't add a passphrase.

ssh-keygen -t rsa -b 2048 -C "Pubkey for ADOMers to spectate" -f\
 /var/lib/adom/etc/adomusers_key
cat /var/lib/adom/etc/adomusers_key.pub >>\
 /var/lib/adom/server/spectator/.ssh/authorized_keys
cat /var/lib/adom/etc/adomusers_key.pub >>\
 /var/lib/adom/server/ttyrecplay/.ssh/authorized_keys

xii. crontab
============

Add the contents of etc/crontab to your crontab 

13. Edit etc/config and fill in the values

14. Exit to root

15. Set permissions:

** NOTE: Spectating requires 'screen' to be setuid root, this makes sure that
 is set. **

cd /var/lib/adom
chgrp adomusers public_html/adom_users/ sockets
chmod 775 public_html/adom_users/ sockets
chmod ugo+x bin/*
chgrp adomusers 1* etr lea swapgame 1*/.HISCORE etr/.HISCORE lea/.HISCORE\
 swapgame/.HISCORE
chmod 775 1* etr lea swapgame
chmod 664 */.HISCORE
chown adom /var/lib/adom/server/registered_ips
chmod 640 /var/lib/adom/server/registered_ips
chmod u+x /var/lib/adom/etc/adom-bots-tmux
chgrp adomusers /var/lib/adom/log/messages_sent
chmod 664 /var/lib/adom/log/messages_sent
# for spectating
chmod u+s `which screen`
chmod 755 /var/run/screen/
# for messaging
chown root:adomusers /var/lib/adom/bin/message_dispatch
chmod 4710 /var/lib/adom/bin/message_dispatch

16. Copy server/etc/adom_ds* to /etc/:

cp /var/lib/adom/etc/adom_ds* /etc/

17. Add your admin SSH pubkey to /var/lib/adom/etc/skel/.ssh/authorized_keys

18. Link public_html into your web server, example:

rmdir /var/www; ln -s /var/lib/adom/public_html /var/www

19. Run: ldconfig

20. Set up a web server.  Enable PHP and edit the variables at the top of 
index.php.  Or, don't enable PHP, strip the PHP out of index.php and replace it
with your hard-coded info, and rename index.php to index.html.

II. ADOM Sage
--------------

ADOM Sage is included, but new versions of ADOM Sage can be found at
https://github.com/AlucardZero/adom-sage 

To add, check out and compile the code, then move adom-sage and adom-sage.so
to the bin/ directory of the server homedir, with an extenstion like -092.

E.g.:
bin/adom-sage-092
bin/adom-sage-092.so

Then edit the SAGE variable in bin/adom-120pX to your new suffix.
